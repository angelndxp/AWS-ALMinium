## ＜これは何？＞

　GitHubで公開されているRedmineを一発展開できるOSS「ALMinium」を、Amazon S3、Amazon RDS、Amzon SESを利用して高可用構成にしよう！というものです。 リポジトリ保存ディレクトリと、FilesディレクトリがS3に、データベースがRDSに、システムメール配信がSESに変更されます。使うには各リソースの事前準備が必要です。

## ＜事前準備＞
* Amazon EC2のAmazon Linuxインスタンスを立ち上げてください。(64ビット、スモール以上を推奨)
* Amazon S3のバケットをあらかじめ準備しておいてください。
* Amazon RDSを、MySQLでセットアップしておいてください。
* Amazon SESをセットアップし、メール認証を完了させておいてください。

## ＜使用するのに必要なパラメーター＞

### Amazon S3の設定用
* バケット名
* アクセスキー
* シークレットアクセスキー

### Amazon RDSの設定用
* エンドポイント
* データベース名
* ユーザー名
* パスワード

### Amazon SESの設定用
* SMTPサーバー名
* SMTPユーザー名(IAM SMTP Credentialsの作成をして取得)
* SMTPパスワード(IAM SMTP Credentialsの作成をして取得)

### ALMiniumサイトのホスト名
* ホスト名 (例:alminium.example.com)

## ＜使い方＞
1. EC2インスタンスにログインしsudoでroot権限ユーザーになります。
2. /usr/local/src に移動します。
3. ALMinium_EC2Install.sh をダウンロードして転送、もしくは新しいファイルに内容を全部コピーします。
4. viなどでファイルを開き、スクリプトの最初にあるAdditional Paramaterにパラメーターを書き込み、変数を埋めます。
5. sh ALMinium_EC2Install.sh
6. あとは全自動で、「HTTPで公開された状態」になります。EC2のエンドポイントからアクセスできます。(かなり時間がかかります)
7. ELBを設定してHTTPS化するなり、オートスケーリングを設定するなりお好きにどうぞ。

### ＜補足＞
*  HTTPSで公開する方法も模索しソースに一部残っていますが、スケールのことを考えるとEC2はHTTPにしておき、ELBを使用してHTTPSを設定した方がうまくいきます。
*  s3fsのバージョン指定がありますが、将来バージョンが変更されたときに今のバージョンリンクが消えると困るので、念のため設定用に残してあります。
* メールの設定は、G-mailも使うことができます。TLSはこの時点で有効化されているので、G-mailのサーバー指定とID/Passの設定をしてやれば動きます。


## ＜このスクリプトを使う利点＞

## 1. Amazon S3と、Amazon RDS の高可用なシステムを使う
* 「データの消えないストレージ」として設計され進化を続けるS3、ゾーンをまたいだMulti AZ配備ができるRDSと、EC2のEBSよりも高可用に設計されたシステムにデータ部分を移すことで、システムの信頼性が格段に向上します。
* S3には「容量の制限」という概念が存在せず、使った分だけ支払えば、S3の仕様の限界まで無限拡張可能です。
* RDSの容量拡張は、容量拡張設定をして「再起動を待つだけ」で簡単です。

## 2. 既存のものより、高可用設定が簡単で、使い勝手がいい
* BitNamiや、Right Scriptで作成したものは、「EC2の中で完結」します。これでは、真の高可用とはいえません。
* CloudFormationにRDSを用いたRedmineサンプルがあるが、これはリポジトリディレクトリやfilesディレクトリをEC2に残したままになります。
* CloudFormationのテンプレートや、BitNamiのAMIは、Redmineがほぼ「素」の状態なので、カスタムが必要です。
* EC2のEBSで容量限界に達すると、基本的に「全部作り直し」になるが、その心配から解放されます。

## 3. 設定により「スケーリング可能」な構成です
* データ部分を本体から追い出したことで、データベースの参照設定とS3のマウント設定を同じにすればスケール可能です。
* インストール後に、EBSイメージをAMI化し、ELB配下でオートスケールをさせても動作します。

## 4. S3をGradinetなどでマウントすれば、バックアップも簡単です
* リポジトリの中身や、Wikiの画像データなどは、すべてS3の中にありますので、取り出してバックアップすることが簡単にできます。

## 5.アップグレードも簡単です
1. 稼働しているものとは別のEC2インスタンスを準備します。
2. 同じパラメーターを使って 同じ手順で ALMinium_EC2Install_Update.sh を走らせます。このスクリプトは、初期設定の「DBの設定を移植する」部分を実行せず、ファイルマウントはALMiniumのインストール後の実行となるように変更してあります。
3. Redmineのバージョンによってうまく動かない場合、RDSでデータベースマイグレーションコマンドを走らせます。(方法はRedmineサイトを参照)
4. <注意>DBのマイグレーション処理により、「旧バージョンでは動きがおかしくなる」こともあるので、旧バージョンのEC2は止めて実施した方が無難です。

